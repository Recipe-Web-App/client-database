# Pre-commit hooks configuration for client-database
# See https://pre-commit.com for more information

default_language_version:
  python: python3.11

repos:
  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
      - id: check-added-large-files
        name: Check for large files
        args: [--maxkb=500]
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: detect-private-key
        name: Detect private keys
      - id: mixed-line-ending
        name: Fix mixed line endings
        args: [--fix=lf]
      - id: check-case-conflict
        name: Check for case conflicts
      - id: check-executables-have-shebangs
        name: Check executables have shebangs

  # SQL linting and formatting
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 4.0.0a1
    hooks:
      - id: sqlfluff-fix
        name: Lint and fix SQL files
        args: [--dialect, mysql, --exclude-rules, "RF04,RF05"]
        files: \.sql$

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        name: Lint shell scripts
        args: [--severity=warning]
        files: \.(sh|bash)$

  # Shell script formatting
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.12.0-2
    hooks:
      - id: shfmt
        name: Format shell scripts
        args: [-i, "2", -ci, -bn, -w] # 2-space indent, indent switch cases, binary ops at line start, write to file
        files: \.(sh|bash)$

  # Kubernetes manifest validation and linting
  - repo: https://github.com/stackrox/kube-linter
    rev: v0.7.6
    hooks:
      - id: kube-linter
        name: Lint Kubernetes manifests
        files: ^k8s/.*\.yaml$

  # Dockerfile linting
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint
        name: Lint Dockerfiles
        args: [--ignore, DL3008, --ignore, DL3009, --ignore, DL3041] # Ignore pin versions (can adjust as needed)
        files: ^tools/Dockerfile\.(jobs|mysql)$

  # Docker and filesystem security scanning
  - repo: https://github.com/mxab/pre-commit-trivy
    rev: v0.16.0
    hooks:
      - id: trivyfs-docker
        name: Scan filesystem for vulnerabilities
        args:
          - --severity
          - HIGH,CRITICAL
          - --exit-code
          - "1"
          - .

  # Secret scanning
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.29.0
    hooks:
      - id: gitleaks
        name: Scan for secrets

  # YAML linting
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        name: Lint YAML files
        args: [-c, .yamllint.yaml]
        files: \.(yaml|yml)$

  # YAML formatting
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: Format YAML files
        types: [yaml]
        args: [--write, --prose-wrap, always, --print-width, "120"]

  # Markdown linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.45.0
    hooks:
      - id: markdownlint
        name: Lint Markdown files
        args: [--config, .markdownlint.yaml, --fix]
        files: \.md$

  # Makefile linting
  - repo: https://github.com/mrtazz/checkmake
    rev: 0.2.2
    hooks:
      - id: checkmake
        name: Lint Makefile
        files: ^Makefile$|\.mk$

  # Commit message linting
  - repo: https://github.com/alessandrojcm/commitlint-pre-commit-hook
    rev: v9.23.0
    hooks:
      - id: commitlint
        name: Lint commit message
        stages: [commit-msg]
        additional_dependencies: ["@commitlint/config-conventional@19.6.0"]

# Configuration for specific file patterns
files: ""
exclude: |
  (?x)^(
    db/data/backups/.*|
    db/data/exports/.*|
    node_modules/.*|
    .git/.*|
    \.tmp/.*
  )$
