name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to deploy to
        required: true
        type: choice
        options:
          - development
          - staging
          - production
  push:
    branches:
      - develop

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'development' }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: kubeconform -summary k8s/*.yaml

  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'development' }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment || 'development' }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          kubectl config use-context ${{ secrets.KUBE_CONTEXT }}

      - name: Set namespace
        id: namespace
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "namespace=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "namespace=staging" >> $GITHUB_OUTPUT
          else
            echo "namespace=default" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Kubernetes
        run: |
          export NAMESPACE=${{ steps.namespace.outputs.namespace }}
          ./scripts/containerManagement/deploy-container.sh

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=ready pod -l app=mysql \
            -n ${{ steps.namespace.outputs.namespace }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          ./scripts/containerManagement/get-container-status.sh

      - name: Run smoke tests
        run: |
          ./scripts/dbManagement/verify-health.sh
